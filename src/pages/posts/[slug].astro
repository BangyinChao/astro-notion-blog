---
import * as interfaces from '../../lib/interfaces.ts'
import {
  getPosts,
  getAllPosts,
  getPostBySlug,
  getBlock,
  getAllBlocksByBlockId,
  downloadFile,
} from '../../lib/notion/client.ts'
import {
  getPostLink,
  filePath,
  extractTargetBlocks,
} from '../../lib/blog-helpers.ts'
import Layout from '../../layouts/Layout.astro'
import PostDate from '../../components/PostDate.astro'
import PostTags from '../../components/PostTags.astro'
import PostTitle from '../../components/PostTitle.astro'
import PostBody from '../../components/PostBody.astro'
import PostRelativeLink from '../../components/PostRelativeLink.astro'

export async function getStaticPaths() {
  const posts = await getAllPosts()
  return posts.map((post: interfaces.Post) => ({ params: { slug: post.Slug } }))
}

const { slug } = Astro.params

const post = await getPostBySlug(slug)
if (!post) {
  throw new Error(`Post not found. slug: ${slug}`)
}

const [blocks, allPosts] = await Promise.all([
  getAllBlocksByBlockId(post.PageId),
  getAllPosts(),
])

const fileAtacchedBlocks = extractTargetBlocks('image', blocks)
  .concat(extractTargetBlocks('file', blocks))
  .filter((block) => {
    if (!block) return false
    const imageOrFile = block.Image || block.File
    return imageOrFile && imageOrFile.File && imageOrFile.File.Url
  })

await Promise.all(
  fileAtacchedBlocks
    .map(async (block) => {
      const expiryTime = (block.Image || block.File).File.ExpiryTime
      if (Date.parse(expiryTime) > Date.now()) {
        return Promise.resolve(block)
      }
      return getBlock(block.Id)
    })
    .map((promise) =>
      promise.then((block) => {
        let url!: URL
        try {
          url = new URL((block.Image || block.File).File.Url)
        } catch {
          console.log('Invalid file URL: ', (block.Image || block.File)?.File?.Url)
          return Promise.reject()
        }
        return Promise.resolve(url)
      })
    )
    .map((promise) => promise.then(downloadFile))
)

const currentPostIndex = allPosts.findIndex((post) => post.Slug === slug)
const prevPost = allPosts[currentPostIndex + 1]
const nextPost = allPosts[currentPostIndex - 1]

let ogImage = ''
if (post.FeaturedImage && post.FeaturedImage.Url) {
  ogImage = new URL(filePath(new URL(post.FeaturedImage.Url)), Astro.site)
}
---

<Layout
  title={post.Title}
  description={post.Excerpt}
  path={getPostLink(post.Slug)}
  ogImage={ogImage}
>
  <article slot="main" class="article">
    <header class="article-header">
      <PostTags post={post} />
      <PostTitle post={post} enableLink={false} />
      <div class="article-meta">
        <PostDate post={post} />
      </div>
    </header>

    <div class="article-body">
      <PostBody blocks={blocks} />
    </div>

    <footer class="article-footer">
      <PostRelativeLink prevPost={prevPost} nextPost={nextPost} />
    </footer>
  </article>
</Layout>

<style>
  .article {
    max-width: 680px;
    margin: 0 auto;
  }

  .article-header {
    padding-bottom: 32px;
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 48px;
  }

  .article-header :global(.tags) {
    margin-bottom: 16px;
  }

  .article-header :global(h1) {
    font-size: 2.2rem;
    font-weight: 700;
    line-height: 1.3;
    color: #111;
    margin-bottom: 20px;
  }

  @media (max-width: 640px) {
    .article-header :global(h1) {
      font-size: 1.7rem;
    }
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: 16px;
    color: #888;
    font-size: 0.9rem;
  }

  .article-body {
    font-size: 1.05rem;
    line-height: 1.9;
    color: #222;
  }

  .article-body :global(h2) {
    font-size: 1.4rem;
    font-weight: 700;
    margin: 2.5rem 0 1rem;
    color: #111;
  }

  .article-body :global(h3) {
    font-size: 1.15rem;
    font-weight: 600;
    margin: 2rem 0 0.75rem;
    color: #111;
  }

  .article-body :global(p) {
    margin: 0 0 1.4rem;
  }

  .article-body :global(img) {
    max-width: 100%;
    border-radius: 8px;
    margin: 1.5rem 0;
  }

  .article-footer {
    margin-top: 64px;
    padding-top: 32px;
    border-top: 1px solid #f0f0f0;
  }
</style>
